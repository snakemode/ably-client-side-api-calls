<!-- This is a static file -->
<!-- served from your routes in server.js -->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Welcome to Glitch!</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="A cool thing made with Glitch">
    <link id="favicon" rel="icon" href="https://glitch.com/edit/favicon-app.ico" type="image/x-icon">

    <!-- import the webpage's stylesheet -->
    <link rel="stylesheet" href="/style.css">
    
    <script src="https://cdn.ably.io/lib/ably.min-1.js"></script>
    <script src="/script.js" defer></script>
    

  </head>
  <body>
    <header>
      <h1>Ably Promises API demo with client side auth.</h1>
    </header>

    <main>
      <h2>Oh hi, let me just grab some history from Ably!</h2>
      <div id="history" class="historyContainer"></div>
    </main>

    <script defer>
      console.log("Oh hai! ðŸ–¤");
      const resultsDiv = document.getElementById("history");

      async function connect() {
        const ably = new Ably.Realtime.Promise({ authUrl: '/api/createTokenRequest' });
        const channelId = `[product:ably-tfl/tube]tube:northern:940GZZLUKSX:arrivals`;
        const channel = await ably.channels.get(channelId);
        await channel.attach();

        channel.subscribe(msg => {
          console.log(msg);
        });

        const resultPage = await channel.history(); 

        for (const item of resultPage.items) {

          const result = document.createElement("div");
          result.classList.add("item");
          result.innerHTML = JSON.stringify(item);
          resultsDiv.appendChild(result);
        }
      }

      connect();    
    </script>    
    
  </body>
</html>
